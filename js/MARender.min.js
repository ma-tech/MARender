MARenderMode={BASIC:0,WIREFRAME:1,LAMBERT:2,PHONG:3,EMISSIVE:4,POINT:5,SECTION:6,MARKER:7,LABEL:8,PATH:9,SHAPE:10},MARenderShape={DISC:0},MARenderItem=function(){this.name=void 0,this.path=void 0,this.color=16777215,this.side=THREE.FrontSide,this.extrude=1,this.transparent=!1,this.opacity=1,this.mode=MARenderMode.PHONG,this.vertices=void 0,this.tangents=void 0,this.normal=new THREE.Vector3(0,0,1),this.position=new THREE.Vector3(0,0,0),this.linewidth=1,this.text=void 0,this.texture=void 0,this.visible=!0,this.clipplane=void 0,this.size=1,this.segments=31,this.style=MARenderShape.DISC},MARenderFont=function(){this.family="Arial",this.weight="Bold",this.size=64},MARenderMarkerMaterial=function(){THREE.SpriteMaterial.apply(this,arguments)},MARenderMarkerMaterial.prototype=Object.create(THREE.SpriteMaterial.prototype),MARenderMarkerMaterial.prototype.constructor=MARenderMarkerMaterial,MARenderLabelMaterial=function(){MARenderMarkerMaterial.apply(this,arguments),this.text=void 0},MARenderLabelMaterial.prototype=Object.create(MARenderMarkerMaterial.prototype),MARenderLabelMaterial.prototype.constructor=MARenderLabelMaterial,MARenderCameraState=function(){this.up=new THREE.Vector3(0,0,1),this.pos=new THREE.Vector3(0,0,0),this.target=new THREE.Vector3(0,0,0)},MARenderColormap={CUSTOM:0,GREYSCALE:1,COOLTOWARM:2,BLACKBODY:3,RAINBOW:4},MARenderLookUpTable=function(colormap){this.type="MARenderer",this.colormap=colormap,this.map=new Array(256);var mappts=void 0;switch(self.colormap){case MARenderColormap.GREYSCALE:case MARenderColormap.COOLTOWARM:mappts=[[0,0,0],[64,64,64][240][191][255]];break;case MARenderColormap.BLACKBODY:mappts=[[0,0,0],128[0][255]];break;case MARenderColormap.RAINBOW:mappts=[[0,0,255],(0)[0][255]]}if(void 0!==mappts)for(var idx=0;idx<256;++idx){var p=idx/64|0,p1=p+1,q=idx-64*p,q1=64-q,n=16320,r=(q1*mappts[p][0]+q*mappts[p1][0])/n,g=(q1*mappts[p][1]+q*mappts[p1][1])/n,b=(q1*mappts[p][2]+q*mappts[p1][2])/n;map.append(new THREE.Color(r,g,b))}},AlphaPointsMaterial=function(params){var vertexShader=["attribute float sizes;","attribute float opacities;","attribute vec3 colors;","uniform float scale;","varying vec3 vColor;","varying float vOpacity;","#include <common>","#include <clipping_planes_pars_vertex>","void main() {","vColor = colors;","vOpacity = opacities;","#include <begin_vertex>","#include <project_vertex>","gl_PointSize = 512.0 * sizes * scale / length(mvPosition.xyz);","#include <clipping_planes_vertex>","}"].join("\n"),fragmentShader=["uniform vec3 diffuse;","uniform float opacity;","uniform sampler2D map;","varying vec3 vColor;","varying float vOpacity;","#include <common>","#include <clipping_planes_pars_fragment>","void main() {","#include <clipping_planes_fragment>","gl_FragColor = vec4(diffuse * vColor, opacity * vOpacity);","gl_FragColor = gl_FragColor * texture2D(map, gl_PointCoord);","if(gl_FragColor.a < ALPHATEST) {","discard;","}","}"].join("\n"),splitParam=[{uniforms:THREE.UniformsUtils.clone(THREE.UniformsLib.points),vertexShader:vertexShader,fragmentShader:fragmentShader},{}];for(var p in params)switch(p){case"map":case"color":splitParam[1][p]=params[p];break;case"scale":case"size":splitParam[1].scale=params[p];break;default:splitParam[0][p]=params[p]}var material=new THREE.ShaderMaterial(splitParam[0]);for(var p in material.type="AlphaPointsMaterial",splitParam[1])switch(p){case"color":material.uniforms.diffuse.value=new THREE.Color(splitParam[1].color);break;case"map":material.uniforms.map.value=splitParam[1].map;break;case"scale":material.uniforms.scale.value=splitParam[1].scale}return material},MARenderer=function(win,con){var self=this;this.type="MARenderer",Object.defineProperty(self,"version",{value:"1.3.3",writable:!1}),this.win=win,this.con=con,this.scene,this.ambLight,this.dirLight,this.pntLight,this.camera,this.cameraControls,this.renderer,this.animCount=0,this.pointSize=10,this.markerSize=50,this.mousePos=new THREE.Vector2(0,0),this.pickOfs=0,this.nearPlane=1,this.farPlane=1e4,this.setCamOnLoad=!0,this.setHomeOnLoad=!0,this.useCameraControl=!0,this.conOffset=new THREE.Vector2(0,0),this.cameraPos=new THREE.Vector3(0,0,1e4),this.center=new THREE.Vector3(0,0,0),this.homeCameraView=new MARenderCameraState,this.saveCameraView=new MARenderCameraState,this.eventHandler=new THREE.EventDispatcher,this.noClipPlanes=Object.freeze([]),this.globalClipping=!1,this.globalClipPlanes=this.noClipPlanes,this.markerAspect=[.3,1],this.labelFont=new MARenderFont,THREE.ImageUtils.crossOrigin="",this.init=function(){this.scene=new THREE.Scene,this.setConOffset(),this.camera=new THREE.PerspectiveCamera(25,this.con.clientWidth/this.con.clientHeight,this.nearPlane,this.farPlane),this.camera.updateProjectionMatrix(),this.cameraControls=this._makeCameraControls(),this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.renderer.setSize(this.con.clientWidth,this.con.clientHeight),this.con.appendChild(this.renderer.domElement),this.scene.add(this.camera),this.ambLight=new THREE.AmbientLight(7829367),this.dirLight=new THREE.DirectionalLight(7829367),this.dirLight.position.set(0,0,1),this.pntLight=new THREE.PointLight(3355443,1,1e4),this.pntLight.position.set(0,.5,0),this.scene.add(this.pntLight),this.camera.add(this.ambLight),this.camera.add(this.dirLight),this.raycaster=new THREE.Raycaster,self.win.addEventListener("mousemove",self._trackMouse,!1),self.win.addEventListener("keypress",self._keyPressed,!1),self.win.addEventListener("resize",self._windowResize,!1)},this.setLocalClipping=function(state){self.renderer.localClippingEnabled=Boolean(state)},this.getLocalClipping=function(){return self.renderer.localClippingEnabled},this.setGlobalClipping=function(state){self.globalClipping=Boolean(state),self.globalClipping?self.renderer.clippingPlanes=this.globalClipPlanes:self.renderer.clippingPlanes=this.noClipPlanes,this.render()},this.setGlobalClipPlane=function(pln){Boolean(pln)&&pln instanceof THREE.Plane&&(self.globalClipPlanes=[pln],self.globalClipping&&(self.renderer.clippingPlanes=self.globalClipPlanes),this.render())},this.setPickOfs=function(ofs){var iofs;self.win.innerHeight,void 0!==ofs&&(iofs=parseInt(ofs,10),self.pickOfs=iofs/self.win.innerHeight*2)},this.addModel=function(gProp){var loader,itm=this._makeRenderItem(gProp);if(itm)switch(Number(itm.mode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:if(itm.path){var ext=itm.path.split(".").pop();"stl"===ext?loader=new THREE.STLLoader:"vtk"===ext?loader=new THREE.VTKLoader:console.log("MARenderer.addModel() unknown file type: "+ext),loader.load(itm.path,function(geom){var mat=self._makeMaterial(geom,itm);if(mat){switch(Number(itm.mode)){case MARenderMode.POINT:var pnts=new THREE.Points(geom,mat);pnts.name=itm.name,pnts.sortParticles=!0,self.scene.add(pnts);break;default:var mesh=new THREE.Mesh(geom,mat);mesh.name=itm.name,self.scene.add(mesh)}self.setCamOnLoad&&(self._computeCenter(),self.setCamera()),self.setHomeOnLoad&&self.setHome(),self.makeLive()}},function(){},function(){console.log("MARenderer.addModel() geometry load failed: "+itm.path)})}break;case MARenderMode.SECTION:if(itm.texture){var secLoader=new THREE.TextureLoader;secLoader.crossOrigin="",secLoader.load(itm.texture,function(tx){var geom=self.makeSectionGeometry(itm.vertices),mat=self._makeMaterial(geom,itm);tx.flipY=!1,tx.minFilter=THREE.LinearFilter,tx.needsUpdate=!0,mat.map=tx;var pln=new THREE.Mesh(geom,mat);pln.name=itm.name,self.scene.add(pln),self.makeLive()},function(){console.log("MARenderer.addModel() texture load failed: "+itm.texture)})}break;case MARenderMode.MARKER:case MARenderMode.LABEL:var geom=void 0,mat=self._makeMaterial(geom,itm),mrk=new THREE.Sprite(mat);itm.mode==MARenderMode.LABEL?mrk.scale.set(this.markerSize,this.markerSize,1):mrk.scale.set(this.markerSize*this.markerAspect[0],this.markerSize*this.markerAspect[1],1),mrk.name=itm.name,mrk.position.set(itm.position.x,itm.position.y,itm.position.z),self.scene.add(mrk),self.makeLive();break;case MARenderMode.PATH:geom=self.makePathGeometry(itm.vertices,itm.tangents);mat=self._makeMaterial(geom,itm);var path=new THREE.Line(geom,mat);path.name=itm.name,self.scene.add(path),self.makeLive();break;case MARenderMode.SHAPE:geom=self.makeShapeGeometry(itm.style,itm.size,itm.segments,itm.extrude);mat=self._makeMaterial(geom,itm);var shape=new THREE.Mesh(geom,mat);shape.name=itm.name,shape.position.set(itm.position.x,itm.position.y,itm.position.z);var d=new THREE.Vector3(itm.normal.x,itm.normal.y,itm.normal.z);d.add(shape.position),shape.lookAt(d),self.scene.add(shape),self.makeLive()}},this.getObjectByName=function(name){return this.scene.getObjectByName(name,!0)},this.updateModel=function(gProp){if(gProp.name){var name=gProp.name,obj=this.scene.getObjectByName(name,!0);obj&&this._updateObj(obj,gProp)}this.render()},this.makePathGeometry=function(vtx,tgt){for(var colors=[],positions=[],tangents=[],geom=new THREE.BufferGeometry,i=0;i<vtx.length;++i){var v=vtx[i];tgt[i];positions.push(v[0],v[1],v[2]),tangents.push(v[0],v[1],v[2]),colors.push(1,1,1)}return geom.addAttribute("position",new THREE.BufferAttribute(new Float32Array(positions),3)),geom.addAttribute("tangent",new THREE.BufferAttribute(new Float32Array(tangents),3)),geom.addAttribute("color",new THREE.BufferAttribute(new Float32Array(colors),3)),geom.computeBoundingBox(),geom.computeBoundingSphere(),geom},this.makeShapeGeometry=function(style,size,segments,extrude){var geom=void 0;switch(style){case MARenderShape.DISC:var shape=new THREE.Shape;shape.moveTo(0,0),shape.absarc(0,0,size,0,2.1*Math.PI,!1),geom=new THREE.ExtrudeGeometry(shape,{bevelEnabled:!1,amount:extrude,curveSegments:segments})}return geom},this.makeSectionGeometry=function(vertices){var geom=new THREE.Geometry;return geom.vertices=vertices?vertices.slice(0):[new THREE.Vector3(0,0,0),new THREE.Vector3(1,0,0),new THREE.Vector3(1,1,0),new THREE.Vector3(0,1,0)],geom.faces=[new THREE.Face3(0,1,2),new THREE.Face3(2,3,0)],geom.faceVertexUvs[0]=[[new THREE.Vector2(0,0),new THREE.Vector2(1,0),new THREE.Vector2(1,1)],[new THREE.Vector2(1,1),new THREE.Vector2(0,1),new THREE.Vector2(0,0)]],geom.computeFaceNormals(),geom.computeBoundingBox(),geom},this.makePlaneFromAngles=function(pit,yaw,fxd,dst){var cp=Math.cos(pit),cy=Math.cos(yaw),sp=Math.sin(pit),sy=Math.sin(yaw),nrm=new THREE.Vector3(sp*cy,sp*sy,cp);return dst+=fxd.x*nrm.x+fxd.y*nrm.y+fxd.z*nrm.z,new THREE.Plane(nrm,-dst)},this.setConOffset=function(){for(var c=self.con,o=new THREE.Vector2(0,0);c;)o.x+=c.offsetLeft,o.y+=c.offsetTop,c=c.offsetParent;self.conOffset.copy(o)},this.makePlaneFromVertices=function(vtx){var pln;vtx&&vtx instanceof Array&&vtx.length>=3&&(pln=new THREE.Plane).setFromCoplanarPoints(vtx[0],vtx[1],vtx[2]);return pln},this.setCamera=function(cen,near,far,pos){cen||near||far||pos?(this.setCamOnLoad=!1,cen&&this.center.copy(cen),near&&(this.nearPlane=near),far&&(this.farPlane=far),pos&&this.cameraPos.copy(pos)):this._computeCenter(),this.camera.near=this.nearPlane,this.camera.far=this.farPlane,this.camera.updateProjectionMatrix(),this.camera.position.copy(this.cameraPos)},this.setHome=function(pos,up){this.cameraControls&&((pos||up)&&(this.setHomeOnLoad=!1),void 0===pos&&(pos=this.cameraControls.object.position.clone()),void 0===up&&(up=this.cameraControls.object.up.clone()),this.homeCameraView.up.copy(up),this.homeCameraView.pos.copy(pos),this.goHome())},this.goHome=function(){this.cameraControls&&(this.cameraControls.up0.copy(this.homeCameraView.up),this.cameraControls.position0.copy(this.homeCameraView.pos),this.cameraControls.target0.copy(this.center),this.cameraControls.reset())},this.removeModel=function(name){var obj=this.scene.getObjectByName(name,!0);obj&&(this.scene.remove(obj),obj.material&&obj.material.dispose(),obj.geometry&&obj.geometry.dispose(),this.render())},this.getChildren=function(){return this.scene.children},this._opacityClamp=function(op){return op>1?op=1:op<0&&(op=0),op},this.opacityIncrement=function(inc){for(var i=0,l=this.scene.children.length;i<l;i++){var child=this.scene.children[i];if(child&&"Mesh"===child.type&&child.material&&child.material.transparent&&void 0!=child.material.opacity){var op=child.material.opacity,tr=child.material.transparent;inc>0&&op<inc?op=inc:op*=1+inc,op=this._opacityClamp(op),this._setMaterialOpacity(child.material,tr,op),child.material.needsUpdate=!0}}},this._pointSizeClamp=function(sz){return sz>99.9?sz=99.9:sz<.1&&(sz=.1),sz},this.pointSizeSet=function(sz){var update=!1;void 0!==sz&&(this.pointSize=this._pointSizeClamp(sz));for(var i=0,l=this.scene.children.length;i<l;i++){var child=this.scene.children[i];if(child&&"Points"===child.type){var mat=child.material;mat&&("PointsMaterial"==mat.type?(update=!0,mat.needsUpdate=!0,mat.size=this.pointSize):"AlphaPointsMaterial"==mat.type&&(update=!0,mat.needsUpdate=!0,mat.uniforms.scale.value=this.pointSize))}}update&&this.render()},this.pointSizeIncrement=function(inc){this.pointSize=this._pointSizeClamp(this.pointSize*(1+inc)),this.pointSizeSet()},this._markerSizeClamp=function(sz){return sz>199.9?sz=199.9:sz<.1&&(sz=.1),sz},this.markerSizeSet=function(sz){void 0!==sz&&(this.markerSize=this._markerSizeClamp(sz));for(var i=0,l=this.scene.children.length;i<l;i++){var child=this.scene.children[i];child&&"Sprite"===child.type&&(void 0!==child.material.text?child.scale.set(this.markerSize,this.markerSize,1):child.scale.set(this.markerSize*this.markerAspect[0],this.markerSize*this.markerAspect[1],1))}},this.render=function(){this.renderer.render(self.scene,self.camera)},this.setCameraControl=function(state){var newState=Boolean(state);newState!=this.useCameraControl&&(this.useCameraControl?this.cameraControls&&(this.saveCameraView.up.copy(this.cameraControls.object.up.clone()),this.saveCameraView.pos.copy(this.cameraControls.object.position.clone()),this.saveCameraView.target.copy(this.center),this.cameraControls.enabled=!1):(this.cameraControls.enabled=!0,this.cameraControls.up0.copy(this.saveCameraView.up),this.cameraControls.position0.copy(this.saveCameraView.pos),this.cameraControls.target0.copy(this.saveCameraView.target),this.cameraControls.reset()),this.useCameraControl=newState)},this.getCameraControl=function(){return this.useCameraControl},this.animate=function(){var aid=self.win.requestAnimationFrame(self.animate);self.useCameraControl&&self.cameraControls&&(self.cameraControls.update(),0==self.animCount&&self.handleWindowResize()),self.render(),++self.animCount>200&&self.win.cancelAnimationFrame(aid)},this.makeLive=function(){var count=this.animCount;self.animCount=0,count>200&&self.animate()},this.addEventListener=function(type,listener){this.eventHandler.addEventListener(type,listener)},this.removeEventListener=function(type,listener){this.eventHandler.removeEventListener(type,listener)},this.getIIP3DBBVertices=function(url,vsz){var prmX=[0,1,1,0],prmY=[0,0,1,1],max=new THREE.Vector2,vtx=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],req=new XMLHttpRequest;if(req.open("GET",url+"&OBJ=Wlz-true-voxel-size",!1),req.send(null),req.open("GET",url+"&OBJ=Max-size",!1),req.send(null),200===req.status){var rsp=req.responseText.split(":")[1].split(" ");max.x=rsp[0]-1,max.y=rsp[1]-1}for(var idx=0;idx<4;++idx)if(req.open("GET",url+"&PRL=-1,"+prmX[idx]*max.x+","+prmY[idx]*max.y+"&OBJ=Wlz-coordinate-3D",!1),req.send(null),200===req.status){rsp=req.responseText.split(":")[1].split(" ");vtx[idx].set(rsp[0]*vsz.x,rsp[1]*vsz.y,rsp[2]*vsz.z)}return vtx},this._makeCameraControls=function(){var cc=new THREE.TrackballControls(this.camera,this.con);return cc.panSpeed=.3,cc.dynamicDampingFactor=.7,cc},this._setMaterialOpacity=function(mat,tr,op){mat&&tr&&(op<.01?mat.opacity=0:(op>1&&(op=1),mat.depthWrite=!(op<.9),mat.opacity=op),this.render())},this._updateObj=function(obj,gProp){var itm=new MARenderItem;if(itm){if(gProp.color?itm.color=gProp.color:obj.material&&obj.material.color&&(itm.color=obj.material.color),void 0!==gProp.clipping)if(gProp.clipping instanceof THREE.Plane){var pln=(new THREE.Plane).copy(gProp.clipping);itm.clipping=[pln]}else itm.clipping=this.noClipPlanes;else obj.material&&(itm.clipping=obj.material.clippingPlanes);if(gProp.opacity?itm.opacity=gProp.opacity:obj.material&&obj.material.opacity&&(itm.opacity=obj.material.opacity),void 0!==gProp.transparent?itm.transparent=gProp.transparent:obj.material&&obj.material.transparent&&(itm.transparent=obj.material.transparent),void 0!==gProp.side?itm.side=gProp.side:obj.material&&(itm.side=obj.material.side),void 0!==gProp.visible?itm.visible=gProp.visible:obj.material&&(itm.visible=obj.material.visible),void 0!==gProp.size&&(itm.size=gProp.size),void 0!==gProp.extrude&&(itm.extrude=gProp.extrude),void 0!==gProp.linewidth?itm.linewidth=gProp.linewidth:"Line"===obj.type&&(itm.linewidth=obj.material.linewidth),void 0!==gProp.segments&&(itm.segments=gProp.segments),gProp.texture&&(itm.texture=gProp.texture.slice(0)),gProp.vertices&&(itm.vertices=gProp.vertices.slice(0)),gProp.tangents&&(itm.tangents=gProp.tangents.slice(0)),gProp.position?itm.position=gProp.position:("Sprite"===obj.type||void 0!==obj.geometry&&"ExtrudeGeometry"==obj.geometry.type)&&(itm.position=obj.position),gProp.normal&&(itm.normal=gProp.normal),gProp.text?itm.text=gProp.text:"Sprite"===obj.type&&void 0!==obj.material&&void 0!==obj.material.text&&(itm.text=obj.material.text),gProp.mode){var mode=this._checkRenderMode(gProp.mode);mode&&(itm.mode=mode)}else"Line"===obj.type?itm.mode=MARenderMode.PATH:void 0!==obj.geometry&&"ExtrudeGeometry"===obj.geometry.type?itm.mode=MARenderMode.SHAPE:"Points"===obj.type?itm.mode=MARenderMode.POINT:obj.material&&("SpriteMaterial"===obj.material.type?void 0!==obj.material.text?itm.mode=MARenderMode.LABEL:itm.mode=MARenderMode.MARKER:itm.mode=MARenderMode.SECTION)}switch(Number(itm.mode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:var mat=this._makeMaterial(obj.geometry,itm),oldmat=obj.material;obj.material=mat,oldmat&&oldmat.dispose();break;case MARenderMode.SECTION:obj.material.visible=itm.visible,obj.material.opacity=itm.opacity,itm.texture&&THREE.ImageUtils.loadTexture(itm.texture,THREE.UVMapping,function(tex){var oldgeom=obj.geometry,oldtex=obj.material.map,geom=self.makeSectionGeometry(itm.vertices);tex.flipY=!1,tex.minFilter=THREE.LinearFilter,tex.needsUpdate=!0,obj.material.map=tex,obj.geometry=geom,oldtex.dispose(),oldgeom.dispose(),self.makeLive()},function(){console.log("MARenderer.updateObj() texture load failed: "+itm.texture)});break;case MARenderMode.LABEL:case MARenderMode.MARKER:mat=this._makeMaterial(obj.geometry,itm),oldmat=obj.material;obj.material=mat,oldmat&&oldmat.dispose(),itm.position&&obj.position.set(itm.position.x,itm.position.y,itm.position.z);break;case MARenderMode.SHAPE:if(pos=obj.position,itm.style||itm.size||itm.segments||itm.extrude){var oldgeom=obj.geometry,geom=self.makeShapeGeometry(itm.style,itm.size,itm.segments,itm.extrude);oldgeom.dispose(),obj.geometry=geom}oldmat=obj.material,mat=this._makeMaterial(obj.geometry,itm);if(oldmat.dispose(),obj.material=mat,itm.position&&(obj.position.set(itm.position.x,itm.position.y,itm.position.z),itm.normal)){var d=new THREE.Vector3(itm.normal.x,itm.normal.y,itm.normal.z);d.add(obj.position),obj.lookAt(d)}break;case MARenderMode.PATH:if(itm.vertices||itm.tangents){oldgeom=obj.geometry,geom=self.makePathGeometry(itm.vertices,itm.tangents);oldgeom.dispose(),obj.geometry=geom}oldmat=obj.material,mat=this._makeMaterial(obj.geometry,itm);oldmat.dispose(),obj.material=mat}},this._updateAllMesh=function(gProp){for(var i=0,l=this.scene.children.length;i<l;i++){var child=this.scene.children[i];child&&"Mesh"===child.type&&child.material&&!child.material.map&&(this._updateObj(child,gProp),this.render())}},this._makeRenderItem=function(gProp){var ok=!0,itm=new MARenderItem;for(var p in gProp)switch(p){case"name":case"path":case"side":case"text":case"position":itm[p]=gProp[p];break;case"yaw":case"dist":case"size":case"color":case"pitch":case"style":case"extrude":case"opacity":case"segments":case"linewidth":itm[p]=Number(gProp[p]);break;case"visible":case"transparent":itm[p]=Boolean(gProp[p]);break;case"mode":var mode=this._checkRenderMode(gProp[p]);mode&&(itm[p]=mode);break;case"texture":case"tangents":case"vertices":itm[p]=gProp[p].slice(0);break;case"clipping":if(gProp[p]&&gProp[p]instanceof THREE.Plane){var pln=(new THREE.Plane).copy(gProp[p]);itm.clipping=[pln]}else itm.clipping=this.noClipPlanes;break;default:ok=!1,console.log("MARenderer._makeRenderItem() unknown property: "+p)}return ok||(itm=void 0),itm},this._checkRenderMode=function(gMode){var rMode=void 0;if(gMode)switch(Number(gMode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:case MARenderMode.SECTION:case MARenderMode.MARKER:case MARenderMode.LABEL:case MARenderMode.PATH:case MARenderMode.SHAPE:rMode=gMode;break;default:console.log("MARenderer: Unknown mode: "+gMode)}return rMode},this._makeMaterial=function(geom,itm){var mat,sProp={};switch(itm.mode){case MARenderMode.BASIC:sProp.color=itm.color,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.wiretrame=!1,mat=new THREE.MeshBasicMaterial(sProp);break;case MARenderMode.WIREFRAME:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.transparent=itm.transparent,sProp.wireframe=!0,sProp.wireframeLinewidth=1,mat=new THREE.MeshLambertMaterial(sProp);break;case MARenderMode.LAMBERT:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.transparent=itm.transparent,sProp.wireframe=!1,sProp.side=itm.side,mat=new THREE.MeshLambertMaterial(sProp);break;case MARenderMode.PHONG:case MARenderMode.SHAPE:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.transparent=itm.transparent,sProp.specular=1118481,sProp.wireframe=!1,sProp.side=itm.side,sProp.emissive=0,sProp.shininess=25,this._setMaterialOpacity(sProp,itm.transparent,itm.opacity),mat=new THREE.MeshPhongMaterial(sProp);break;case MARenderMode.EMISSIVE:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.transparent=itm.transparent,sProp.specular=7829367,sProp.wireframe=!1,sProp.emissive=itm.color,sProp.shininess=15,sProp.side=itm.side,mat=new THREE.MeshPhongMaterial(sProp);break;case MARenderMode.POINT:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.visible=itm.visible,sProp.transparent=itm.transparent,sProp.clippingPlanes=itm.clipping,sProp.size=this.pointSize,sProp.blending=THREE.CustomBlending,sProp.blendSrc=THREE.SrcColorFactor,sProp.blendDst=THREE.DstAlphaFactor,sProp.blendEquation=THREE.AddEquation,sProp.alphaTest=.1;var tx=THREE.ImageUtils.loadTexture("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAQAAABuBnYAAAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfgAg8MNSkRqlGqAAAAVElEQVQI113NQQ0DIRBA0TcEFYQTSVWsAHRUWXUgoDY4bbAxPfS2X8D7ATk1nFhU8u0ysLPFp+Z0mTpe5CmaoYNuaMWj4thucNtOjZWNP+obK57bH17lGKmOV2FkAAAAAElFTkSuQmCC");sProp.map=tx,void 0!==geom.attributes.colors&&geom.attributes.colors.array.length>0?(mat=new AlphaPointsMaterial(sProp)).vertexColors=THREE.VertexColors:mat=new THREE.PointsMaterial(sProp);break;case MARenderMode.PATH:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.transparent=itm.transparent,sProp.alphaTest=.2,sProp.visible=itm.visible,sProp.linewidth=itm.linewidth,sProp.clippingPlanes=itm.clipping,sProp.vertexColors=!0,mat=new THREE.LineBasicMaterial(sProp);break;case MARenderMode.SECTION:sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.transparent=itm.transparent,sProp.alphaTest=.2,sProp.visible=itm.visible,sProp.clippingPlanes=itm.clipping,sProp.wireframe=!1,sProp.side=THREE.DoubleSide,mat=new THREE.MeshBasicMaterial(sProp);break;case MARenderMode.MARKER:case MARenderMode.LABEL:if(sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.visible=itm.visible,sProp.transparent=itm.transparent,sProp.alphaTest=.1,sProp.clippingPlanes=itm.clipping,itm.mode===MARenderMode.MARKER){tx=THREE.ImageUtils.loadTexture("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAIAAQMAAADuZfHZAAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfkCRUQCRIVi1+ZAAADLUlEQVRo3u2ZQZKjMAxFoVh46SNwFB8NH81H8RFYsnDZPckEkGR9AjXVmyn9VVdeEvsrWJbUw3CqtThoak0n8wuU/vWxvZX0D7S2qSu8JF+fdpD1b+qXX5r+Xcc3yX35E6wMhBMUsARfZCSvs0UcBVlfm0clUFDB2nR1tjb9tSYOsr429T5zsOmbotvimyLbEq8f2xolSFqk6H69BKu+23O/QYICdnsY6UADNnYjYw+SFvTTiOvBqvvbwdyDDYGiG98dLgg0RRBE3fhf69N3kEYWE0fsehVEspGVhKrQKGwEZBrpjbwp0h+tnKGq7PcnoLBnrJ7vWdnjSkDmp+7ceuRP/gnEIYo7qOLYxf2zRRzUtINNHO20b2MViegAWWSJvP+RRF7J+0ejONsHkLl87cHyAV5mtcBAkWDrwfwBs8ycnoFVgtIDx0DuQZBgYiBJUHsw3gOxB4sEwz3QX64KWP4JVAW0+yAY+H0Af6hr0H4JsCfxyUMNz8f9o8YPJzzOCviSMiBQ0pKXYP6W4UBO3NNr7dMrzLsghfdgRLeBvCayuFgyvnHgHSVvtYDuQXlBHvttEqTuruW3s+vAxqtMXgzwQiGwe7v1IMkqY6YFnVdApWVbodVgIrUWLXFe7woqkBWkewQyquHyVXE3PgLxqrLEtejyANTrQjig0nl+ADZUt2/XBb17APJ1NwH7DwhgKzM01Pwst0FFnVdFvVr51sT522BFHeSqN8Jn8ppQMwq7VNjXDg11wstNUL9327Mew4vG3SPg0AzAoakBHCeMIFQyJhGBG0MOPBYJekRETMqd0YvTI3IxxZkQgAOhEUSEx+TW0Ilar/qITM6vZt04iwkHDs3IJt34xbhtRGAAEcEjvdN6RaCgsaEcQXoEnG78YjQ5AX+n9YjGnx1YwFxUTC56h/1U1qPZq9f9kaIOTGXz/cHvAPwNSpNAHVYEChpHbwrwur+PQw1Mur+Pw/RkSP52qI7Vg+7vbaSowOv+3mBVgdNtvB2qNl4O9f8CDMDGH4cVgIDAXADwGwBuBWDKAIwJgCEOJpPJZDKZTCaTyWQymUwmk8lkMplM/69+AFlip7zBTAeRAAAAAElFTkSuQmCC");sProp.map=tx,mat=new MARenderMarkerMaterial(sProp)}else{sProp.text=itm.text;var canvas=document.createElement("canvas"),context=canvas.getContext("2d");context.font=this.labelFont.weight+" "+this.labelFont.size+"px "+this.labelFont.family,context.lineWidth=1,context.strokeStyle="rgba(255,255,255,255)",context.fillStyle="rgba(255,255,255,255)",context.fillText(sProp.text,1,this.labelFont.size+1),(tx=new THREE.Texture(canvas)).needsUpdate=!0,sProp.map=tx,(mat=new MARenderLabelMaterial(sProp)).text=sProp.text}}return mat},this._computeCenter=function(){for(var d,min,max,dMax,n=0,box=new THREE.Box3,i=0,l=this.scene.children.length;i<l;i++){var child=this.scene.children[i];if(child&&("Mesh"===child.type||"Points"===child.type)){++n;var b=new THREE.Box3;b.setFromObject(child),b.min.add(child.position),b.max.add(child.position),1==n?box.copy(b):box.union(b)}}n>0&&(min=box.min.x,max=box.max.x,dMax=box.max.x-box.min.x,(d=box.max.y-box.min.y)>dMax&&(dMax=d),min>box.min.y&&(min=box.min.y),max<box.max.y&&(max=box.max.y),(d=box.max.z-box.min.z)>dMax&&(dMax=d),min>box.min.z&&(min=box.min.z),max<box.max.z&&(max=box.max.z),this.center.copy(box.center()),this.nearPlane=min<.2?.1:.5*min,this.farPlane=max<1?10:10*max,this.cameraPos.set(0,0,this.center.z+4*dMax))},this._testCode=function(){console.log("ren.version = "+self.version),console.log("cen = ("+self.center.x+", "+self.center.y+", "+self.center.z+")"),console.log("near = "+self.nearPlane),console.log("far = "+self.farPlane),console.log("pos = "+self.camera.position.x+", "+self.camera.position.y+", "+self.camera.position.z+")"),console.log("up = ("+self.camera.up.x+", "+self.camera.up.y+", "+self.camera.up.z+")"),console.log("ren.setCamera(new THREE.Vector3("+self.center.x+", "+self.center.y+", "+self.center.z+"), "+self.nearPlane+", "+self.farPlane+", new THREE.Vector3("+self.camera.position.x+", "+self.camera.position.y+", "+self.camera.position.z+"));\nren.setHome(new THREE.Vector3("+self.cameraControls.object.position.x+", "+self.cameraControls.object.position.y+", "+self.cameraControls.object.position.z+"), new THREE.Vector3("+self.camera.up.x+", "+self.camera.up.y+", "+self.camera.up.z+"));"),console.log("mousePos = ("+self.mousePos.x+", "+self.mousePos.y+")")},this._pick=function(){var pos=self.mousePos;pos.y=pos.y+self.pickOfs,self.raycaster.setFromCamera(pos,self.camera);var isct=self.raycaster.intersectObjects(self.scene.children,!1);isct.length>0&&self.eventHandler.dispatchEvent({type:"pick",hitlist:isct})},this._trackMouse=function(e){self.mousePos.x=(e.clientX-self.conOffset.x)/self.con.clientWidth*2-1,self.mousePos.y=-(e.clientY-self.conOffset.y)/self.con.clientHeight*2+1,self.makeLive()},this._keyPressed=function(e){switch(e.charCode){case 33:self._testCode();break;case 60:self.opacityIncrement(-.1);break;case 62:self.opacityIncrement(.1);break;case 63:self._pick();break;case 67:self.setCamera(),self.goHome();break;case 72:self.setHome();break;case 104:self.goHome();break;case 112:self.pointSizeIncrement(.1);break;case 113:self.pointSizeIncrement(-.1);break;case 115:self._updateAllMesh({mode:MARenderMode.PHONG});break;case 119:self._updateAllMesh({mode:MARenderMode.WIREFRAME})}console.log("MARender: charCode = "+e.charCode)},this._windowResize=function(){self.handleWindowResize(),self.makeLive()},this.handleWindowResize=function(){self.setConOffset(),self.camera.aspect=self.con.clientWidth/self.con.clientHeight,self.camera.updateProjectionMatrix(),self.renderer.setSize(self.con.clientWidth,self.con.clientHeight),self.cameraControls&&self.cameraControls.handleResize()}};
