import*as THREE from"./three.module.js";import{TrackballControls}from"./TrackballControls.js";import{MAVTKLoader}from"./MAVTKLoader.js";import{STLLoader}from"./STLLoader.js";import{LineSegments2}from"./LineSegments2.js";import{LineMaterial}from"./LineMaterial.js";import{LineGeometry}from"./LineGeometry.js";const MARenderMode={BASIC:0,WIREFRAME:1,LAMBERT:2,PHONG:3,EMISSIVE:4,POINT:5,SECTION:6,MARKER:7,LABEL:8,PATH:9,SHAPE:10},MARenderShape={DISC:0};class MARenderItem{constructor(){this.name=void 0,this.path=void 0,this.color=16777215,this.side=THREE.FrontSide,this.extrude=1,this.transparent=!1,this.opacity=1,this.mode=MARenderMode.PHONG,this.vertices=void 0,this.tangents=void 0,this.normals=void 0,this.normal=new THREE.Vector3(0,0,1),this.position=new THREE.Vector3(0,0,0),this.linewidth=1,this.text=void 0,this.texture=void 0,this.visible=!0,this.clipplane=void 0,this.size=1,this.segments=31,this.style=MARenderShape.DISC}}class MARenderFont{constructor(){this.family="Arial",this.weight="Bold",this.size=64}}class MARenderPath extends LineSegments2{constructor(geom,mat){super(geom,mat),this.type="MARenderPath"}}MARenderPath.prototype.isMARenderPath=!0;class MARenderPathMaterial extends LineMaterial{constructor(prop){super(prop),this.type="MARenderPathMaterial"}}MARenderPathMaterial.prototype.isPathMaterial=!0;class MARenderMarkerMaterial extends THREE.SpriteMaterial{constructor(args){super(args)}}class MARenderLabelMaterial extends MARenderMarkerMaterial{constructor(args){let text=args.text;text&&delete args.text,super(args),this.text=text}}class MARenderCameraState{constructor(){this.up=new THREE.Vector3(0,0,1),this.pos=new THREE.Vector3(0,0,0),this.target=new THREE.Vector3(0,0,0)}}class AlphaPointsMaterial extends THREE.ShaderMaterial{constructor(params){let vertexShader=["attribute float sizes;","attribute float opacities;","attribute vec3 colors;","uniform float scale;","varying vec3 vColor;","varying float vOpacity;","#include <common>","#include <clipping_planes_pars_vertex>","void main() {","vColor = colors;","vOpacity = opacities;","#include <begin_vertex>","#include <project_vertex>","gl_PointSize = 512.0 * sizes * scale / length(mvPosition.xyz);","#include <clipping_planes_vertex>","}"].join("\n"),fragmentShader=["uniform vec3 diffuse;","uniform float opacity;","uniform float alphaTest;","uniform sampler2D map;","varying vec3 vColor;","varying float vOpacity;","#include <common>","#include <clipping_planes_pars_fragment>","void main() {","#include <clipping_planes_fragment>","gl_FragColor = vec4(diffuse * vColor, opacity * vOpacity);","gl_FragColor = gl_FragColor * texture2D(map, gl_PointCoord);","if(gl_FragColor.a < alphaTest) {","discard;","}","}"].join("\n"),splitParam=[{uniforms:THREE.UniformsUtils.clone(THREE.UniformsLib.points),vertexShader:vertexShader,fragmentShader:fragmentShader},{}];for(let p in params)switch(p){case"map":case"color":case"alphaTest":splitParam[1][p]=params[p];break;case"scale":case"size":splitParam[1].scale=params[p];break;default:splitParam[0][p]=params[p]}super(splitParam[0]),this.type="AlphaPointsMaterial",this.uniforms.alphaTest.value=1/255;for(let p in splitParam[1])switch(p){case"color":this.uniforms.diffuse.value=new THREE.Color(splitParam[1].color);break;case"map":this.uniforms.map.value=splitParam[1].map;break;case"scale":this.uniforms.scale.value=splitParam[1].scale;break;case"alphaTest":this.uniforms.alphaTest.value=splitParam[1].alphaTest}}}class MARenderer{constructor(win,con){this.type="MARenderer",Object.defineProperty(this,"version",{value:"2.0.2",writable:!1}),this.win=win,this.con=con,this.scene=void 0,this.ambLight=void 0,this.dirLight=void 0,this.pntLight=void 0,this.camera=void 0,this.cameraControls=void 0,this.renderer=void 0,this.animCount=0,this.pointSize=10,this.markerSize=50,this.mousePos=new THREE.Vector2(0,0),this.pickOfs=0,this.nearPlane=1,this.farPlane=1e4,this.setCamOnLoad=!0,this.setHomeOnLoad=!0,this.useCameraControl=!0,this.conOffset=new THREE.Vector2(0,0),this.cameraPos=new THREE.Vector3(0,0,1e4),this.center=new THREE.Vector3(0,0,0),this.homeCameraView=new MARenderCameraState,this.saveCameraView=new MARenderCameraState,this.eventHandler=new THREE.EventDispatcher,this.noClipPlanes=Object.freeze([]),this.globalClipping=!1,this.globalClipPlanes=this.noClipPlanes,this.markerAspect=[.3,1],this.labelFont=new MARenderFont,this.pickTimestamp=0,this.pickMaxPointerDelay=300,THREE.ImageUtils.crossOrigin=""}init(){this.scene=new THREE.Scene,this.setConOffset(),this.camera=new THREE.PerspectiveCamera(25,this.con.clientWidth/this.con.clientHeight,this.nearPlane,this.farPlane),this.camera.updateProjectionMatrix(),this.cameraControls=this._makeCameraControls(),this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this._setRendererSize(this.con.clientWidth,this.con.clientHeight),this.con.appendChild(this.renderer.domElement),this.scene.add(this.camera),this.ambLight=new THREE.AmbientLight(7829367),this.dirLight=new THREE.DirectionalLight(7829367),this.dirLight.position.set(0,0,1),this.pntLight=new THREE.PointLight(3355443,1,1e4),this.pntLight.position.set(0,.5,0),this.scene.add(this.pntLight),this.camera.add(this.ambLight),this.camera.add(this.dirLight),this.raycaster=new THREE.Raycaster,this.win.addEventListener("mousemove",this._trackMouse.bind(this),!1),this.win.addEventListener("keypress",this._keyPressed.bind(this),!1),this.win.addEventListener("resize",this._windowResize.bind(this),!1)}setLocalClipping(state){this.renderer.localClippingEnabled=Boolean(state)}getLocalClipping(){return this.renderer.localClippingEnabled}setGlobalClipping(state){this.globalClipping=Boolean(state),this.globalClipping?this.renderer.clippingPlanes=this.globalClipPlanes:this.renderer.clippingPlanes=this.noClipPlanes,this.render()}setGlobalClipPlane(pln){Boolean(pln)&&pln instanceof THREE.Plane&&(this.globalClipPlanes=[pln],this.globalClipping&&(this.renderer.clippingPlanes=this.globalClipPlanes),this.render())}setPickOfs(ofs){let iofs,innerH;innerH=this.win.innerHeight,void 0!==ofs&&(iofs=parseInt(ofs,10),this.pickOfs=iofs/innerH*2)}addModel(gProp){this.makeLive();let itm=this._makeRenderItem(gProp);if(itm){let mat,geom;switch(Number(itm.mode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:if(itm.path){let loader,ext=itm.path.split(".").pop();"stl"===ext?loader=new STLLoader:"vtk"===ext?loader=new MAVTKLoader:console.log("MARenderer.addModel() unknown file type: "+ext),loader.load(itm.path,function(geom){if(mat=this._makeMaterial(geom,itm)){switch(Number(itm.mode)){case MARenderMode.POINT:let pnts=new THREE.Points(geom,mat);pnts.name=itm.name,this.scene.add(pnts);break;default:let mesh=new THREE.Mesh(geom,mat);mesh.name=itm.name,this.scene.add(mesh)}this.setCamOnLoad&&(this._computeCenter(),this.setCamera()),this.setHomeOnLoad&&this.setHome(),this.makeLive()}}.bind(this),function(){},function(){console.log("MARenderer.addModel() geometry load failed: "+itm.path)})}break;case MARenderMode.SECTION:if(itm.texture){let loader=new THREE.TextureLoader;loader.crossOrigin="",loader.load(itm.texture,function(tx){geom=this.makeSectionGeometry(itm.vertices),mat=this._makeMaterial(geom,itm),tx.flipY=!1,tx.minFilter=THREE.LinearFilter,tx.needsUpdate=!0,mat.map=tx;let pln=new THREE.Mesh(geom,mat);pln.name=itm.name,this.scene.add(pln),this.makeLive()}.bind(this),function(){console.log("MARenderer.addModel() texture load failed: "+itm.texture)})}break;case MARenderMode.MARKER:case MARenderMode.LABEL:geom=void 0,mat=this._makeMaterial(geom,itm);let mrk=new THREE.Sprite(mat);itm.mode==MARenderMode.LABEL?mrk.scale.set(this.markerSize,this.markerSize,1):mrk.scale.set(this.markerSize*this.markerAspect[0],this.markerSize*this.markerAspect[1],1),mrk.name=itm.name,mrk.position.set(itm.position.x,itm.position.y,itm.position.z),this.scene.add(mrk),this.makeLive();break;case MARenderMode.PATH:geom=this.makePathGeometry(itm.vertices,itm.tangents,itm.normals),mat=this._makeMaterial(geom,itm);let path=new MARenderPath(geom,mat);path.name=itm.name,this.scene.add(path),this.makeLive();break;case MARenderMode.SHAPE:geom=this.makeShapeGeometry(itm.style,itm.size,itm.segments,itm.extrude),mat=this._makeMaterial(geom,itm);let shape=new THREE.Mesh(geom,mat);shape.name=itm.name,shape.position.set(itm.position.x,itm.position.y,itm.position.z);let po=itm.position.length(),d=new THREE.Vector3(itm.normal.x,itm.normal.y,itm.normal.z);d.multiplyScalar(po+1),d.add(shape.position),shape.lookAt(d),this.scene.add(shape),this.makeLive()}}}getObjectByName(name){return this.scene.getObjectByName(name,!0)}updateModel(gProp){if(gProp.name){let name=gProp.name,obj=this.scene.getObjectByName(name,!0);obj&&this._updateObj(obj,gProp)}this.render()}makePathGeometry(vtx,tgt,nrm){let colors=[],positions=[],normals=[],tangents=[],geom=new LineGeometry;for(let i=0;i<vtx.length;++i){let v=vtx[i];if(colors.push(1,1,1),positions.push(v[0],v[1],v[2]),void 0!==tgt){let t=tgt[i];tangents.push(t[0],t[1],t[2])}if(void 0!==nrm){let n=nrm[i];normals.push(n[0],n[1],n[2])}}return geom.setPositions(positions),geom.setColors(colors),void 0!==tgt&&geom.setAttribute("tangent",new THREE.Float32BufferAttribute(tangents,3)),void 0!==nrm&&geom.setAttribute("normal",new THREE.Float32BufferAttribute(normals,3)),geom.computeBoundingBox(),geom.computeBoundingSphere(),geom}makeShapeGeometry(style,size,segments,extrude){let geom=void 0;switch(style){case MARenderShape.DISC:let shape=new THREE.Shape;shape.moveTo(0,0),shape.absarc(0,0,size,0,2*Math.PI,!1),geom=new THREE.ExtrudeGeometry(shape,{bevelEnabled:!1,depth:extrude,curveSegments:segments})}return geom}makeSectionGeometry(vertices){const geom=new THREE.BufferGeometry;let vtx;if(vertices){vtx=[];for(let i=0;i<vertices.length;++i){let v=vertices[i];vtx.push(v.x,v.y,v.z)}}else vtx=[0,0,0,1,0,0,1,1,0,0,1,0];return geom.setAttribute("position",new THREE.Float32BufferAttribute(vtx,3)),geom.setAttribute("uv",new THREE.Float32BufferAttribute([0,0,1,0,1,1,0,1],2)),geom.setIndex([0,1,2,2,3,0]),geom.computeVertexNormals(),geom.computeBoundingBox(),geom.computeBoundingSphere(),geom}makePlaneFromAngles(pit,yaw,fxd,dst){let cp=Math.cos(pit),cy=Math.cos(yaw),sp=Math.sin(pit),sy=Math.sin(yaw),nrm=new THREE.Vector3(sp*cy,sp*sy,cp);return dst+=fxd.x*nrm.x+fxd.y*nrm.y+fxd.z*nrm.z,new THREE.Plane(nrm,-dst)}setConOffset(){}setLineResolution(w,h){for(let i=0,l=this.scene.children.length;i<l;i++){let child=this.scene.children[i];child&&"MARenderPath"===child.type&&child.material&&"MARenderPathMaterial"===child.material.type&&child.material.resolution.set(w,h)}}makePlaneFromVertices(vtx){let pln;return vtx&&vtx instanceof Array&&vtx.length>=3&&(pln=new THREE.Plane).setFromCoplanarPoints(vtx[0],vtx[1],vtx[2]),pln}setCamera(cen,near,far,pos){cen||near||far||pos?(this.setCamOnLoad=!1,cen&&this.center.copy(cen),near&&(this.nearPlane=near),far&&(this.farPlane=far),pos&&this.cameraPos.copy(pos)):this._computeCenter(),this.camera.near=this.nearPlane,this.camera.far=this.farPlane,this.camera.updateProjectionMatrix(),this.camera.position.copy(this.cameraPos)}setHome(pos,up){this.cameraControls&&((pos||up)&&(this.setHomeOnLoad=!1),void 0===pos&&(pos=this.cameraControls.object.position.clone()),void 0===up&&(up=this.cameraControls.object.up.clone()),this.homeCameraView.up.copy(up),this.homeCameraView.pos.copy(pos),this.goHome())}goHome(){this.cameraControls&&(this.cameraControls.up0.copy(this.homeCameraView.up),this.cameraControls.position0.copy(this.homeCameraView.pos),this.cameraControls.target0.copy(this.center),this.cameraControls.reset())}removeModel(name){let obj=this.scene.getObjectByName(name,!0);obj&&(this.scene.remove(obj),obj.material&&obj.material.dispose(),obj.geometry&&obj.geometry.dispose(),this.render())}getChildren(){return this.scene.children}handleWindowResize(){this.setConOffset(),this.camera.aspect=this.con.clientWidth/this.con.clientHeight,this.camera.updateProjectionMatrix(),this._setRendererSize(this.con.clientWidth,this.con.clientHeight),this.cameraControls&&this.cameraControls.handleResize()}opacityIncrement(inc){for(let i=0,l=this.scene.children.length;i<l;i++){let child=this.scene.children[i];if(child&&"Mesh"===child.type&&child.material&&child.material.transparent&&void 0!=child.material.opacity){let op=child.material.opacity,tr=child.material.transparent;inc>0&&op<inc?op=inc:op*=1+inc,op=this._opacityClamp(op),this._setMaterialOpacity(child.material,tr,op),child.material.needsUpdate=!0}}}pointSizeSet(sz){let update=!1;void 0!==sz&&(this.pointSize=this._pointSizeClamp(sz));for(let i=0,l=this.scene.children.length;i<l;i++){let child=this.scene.children[i];if(child&&"Points"===child.type){let mat=child.material;mat&&("PointsMaterial"==mat.type?(update=!0,mat.needsUpdate=!0,mat.size=this.pointSize):"AlphaPointsMaterial"==mat.type&&(update=!0,mat.needsUpdate=!0,mat.uniforms.scale.value=this.pointSize))}}update&&this.render()}pointSizeIncrement(inc){this.pointSize=this._pointSizeClamp(this.pointSize*(1+inc)),this.pointSizeSet()}markerSizeSet(sz){if(void 0!==sz&&(this.markerSize=this._markerSizeClamp(sz)),void 0!==this.scene&&void 0!==this.scene.children)for(let i=0,l=this.scene.children.length;i<l;i++){let child=this.scene.children[i];child&&"Sprite"===child.type&&(void 0!==child.material.text?child.scale.set(this.markerSize,this.markerSize,1):child.scale.set(this.markerSize*this.markerAspect[0],this.markerSize*this.markerAspect[1],1))}}render(){this.renderer.clearDepth(),this.renderer.render(this.scene,this.camera)}setCameraControl(state){let newState=Boolean(state);newState!=this.useCameraControl&&(this.useCameraControl?this.cameraControls&&(this.saveCameraView.up.copy(this.cameraControls.object.up.clone()),this.saveCameraView.pos.copy(this.cameraControls.object.position.clone()),this.saveCameraView.target.copy(this.center),this.cameraControls.enabled=!1):(this.cameraControls=this._makeCameraControls(),this.cameraControls.enabled=!0,this.cameraControls.up0.copy(this.saveCameraView.up),this.cameraControls.position0.copy(this.saveCameraView.pos),this.cameraControls.target0.copy(this.saveCameraView.target),this.cameraControls.reset()),this.useCameraControl=newState)}getCameraControl(){return this.useCameraControl}animate(){let anim=this.animate.bind(this),aid=this.win.requestAnimationFrame(anim);this.useCameraControl&&this.cameraControls&&(this.cameraControls.update(),0==this.animCount&&this.handleWindowResize()),this.render.bind(this)(),(this.scene.children.length<1||++this.animCount>200)&&this.win.cancelAnimationFrame(aid)}makeLive(){let count=this.animCount;this.animCount=0,count>200&&this.animate()}addEventListener(type,listener){this.eventHandler.addEventListener(type,listener)}removeEventListener(type,listener){this.eventHandler.removeEventListener(type,listener)}getIIP3DBBVertices(url,vsz){let prmX=[0,1,1,0],prmY=[0,0,1,1],max=new THREE.Vector2,vtx=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],req=new XMLHttpRequest;if(req.open("GET",url+"&OBJ=Wlz-true-voxel-size",!1),req.send(null),req.open("GET",url+"&OBJ=Max-size",!1),req.send(null),200===req.status){let rsp=req.responseText.split(":")[1].split(" ");max.x=rsp[0]-1,max.y=rsp[1]-1}for(let idx=0;idx<4;++idx)if(req.open("GET",url+"&PRL=-1,"+prmX[idx]*max.x+","+prmY[idx]*max.y+"&OBJ=Wlz-coordinate-3D",!1),req.send(null),200===req.status){let rsp=req.responseText.split(":")[1].split(" ");vtx[idx].set(rsp[0]*vsz.x,rsp[1]*vsz.y,rsp[2]*vsz.z)}return vtx}static _clamp(v,min,max){return v<min?v=min:v>max&&(v=max),v}_setRendererSize(w,h){this.renderer.setSize(w,h),this.setLineResolution(w,h)}_opacityClamp(op){return op=MARenderer._clamp(op,0,1)}_pointSizeClamp(sz){return sz=MARenderer._clamp(sz,.1,99.9)}_markerSizeClamp(sz){return sz=MARenderer._clamp(sz,.1,199.9)}_makeCameraControls(){let cc=new TrackballControls(this.camera,this.con);return cc.panSpeed=.3,cc.dynamicDampingFactor=.7,cc}_setMaterialOpacity(mat,tr,op){mat&&tr&&(op<.01?mat.opacity=0:(op>1&&(op=1),mat.depthWrite=!(op<.9),mat.opacity=op),this.render())}_updateObj(obj,gProp){this.makeLive();let itm=new MARenderItem;if(itm){if(gProp.color?itm.color=gProp.color:obj.material&&obj.material.color&&(itm.color=obj.material.color),void 0!==gProp.clipping)if(gProp.clipping instanceof THREE.Plane){let pln=(new THREE.Plane).copy(gProp.clipping);itm.clipping=[pln]}else itm.clipping=this.noClipPlanes;else obj.material&&(itm.clipping=obj.material.clippingPlanes);if(gProp.opacity?itm.opacity=gProp.opacity:obj.material&&obj.material.opacity&&(itm.opacity=obj.material.opacity),void 0!==gProp.transparent?itm.transparent=gProp.transparent:obj.material&&obj.material.transparent&&(itm.transparent=obj.material.transparent),void 0!==gProp.side?itm.side=gProp.side:obj.material&&(itm.side=obj.material.side),void 0!==gProp.visible?itm.visible=gProp.visible:obj.material&&(itm.visible=obj.material.visible),void 0!==gProp.size&&(itm.size=gProp.size),void 0!==gProp.extrude&&(itm.extrude=gProp.extrude),void 0!==gProp.linewidth?itm.linewidth=gProp.linewidth:"MARenderPath"===obj.type&&(itm.linewidth=obj.material.linewidth),void 0!==gProp.segments&&(itm.segments=gProp.segments),gProp.texture&&(itm.texture=gProp.texture.slice(0)),gProp.vertices&&(itm.vertices=gProp.vertices.slice(0)),gProp.tangents&&(itm.tangents=gProp.tangents.slice(0)),gProp.normals&&(itm.normals=gProp.normals.slice(0)),gProp.position?itm.position=gProp.position:("Sprite"===obj.type||void 0!==obj.geometry&&"ExtrudeGeometry"==obj.geometry.type)&&(itm.position=obj.position),gProp.normal&&(itm.normal=gProp.normal),gProp.text?itm.text=gProp.text:"Sprite"===obj.type&&void 0!==obj.material&&void 0!==obj.material.text&&(itm.text=obj.material.text),gProp.mode){let mode=this._checkRenderMode(gProp.mode);mode&&(itm.mode=mode)}else"MARenderPath"===obj.type?itm.mode=MARenderMode.PATH:void 0!==obj.geometry&&"ExtrudeGeometry"===obj.geometry.type?itm.mode=MARenderMode.SHAPE:"Points"===obj.type?itm.mode=MARenderMode.POINT:obj.material&&("SpriteMaterial"===obj.material.type?void 0!==obj.material.text?itm.mode=MARenderMode.LABEL:itm.mode=MARenderMode.MARKER:itm.mode=MARenderMode.SECTION)}switch(Number(itm.mode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:{let mat=this._makeMaterial(obj.geometry,itm),oldmat=obj.material;obj.material=mat,oldmat&&oldmat.dispose()}break;case MARenderMode.SECTION:if(obj.material.visible=itm.visible,obj.material.opacity=itm.opacity,itm.texture&&itm.vertices){let loader=new THREE.TextureLoader;loader.crossOrigin="",loader.load(itm.texture,function(tex){let oldgeom=obj.geometry,oldtex=obj.material.map,geom=this.makeSectionGeometry(itm.vertices);tex.flipY=!1,tex.minFilter=THREE.LinearFilter,tex.needsUpdate=!0,obj.material.map=tex,obj.geometry=geom,oldtex.dispose(),oldgeom.dispose(),this.makeLive()}.bind(this),void 0,function(){console.log("MARenderer.updateObj() texture load failed: "+itm.texture)})}break;case MARenderMode.LABEL:case MARenderMode.MARKER:{let mat=this._makeMaterial(obj.geometry,itm),oldmat=obj.material;obj.material=mat,oldmat&&oldmat.dispose(),itm.position&&obj.position.set(itm.position.x,itm.position.y,itm.position.z)}break;case MARenderMode.SHAPE:{obj.position;if(itm.style||itm.size||itm.segments||itm.extrude){let oldgeom=obj.geometry,geom=this.makeShapeGeometry(itm.style,itm.size,itm.segments,itm.extrude);oldgeom.dispose(),obj.geometry=geom}let oldmat=obj.material,mat=this._makeMaterial(obj.geometry,itm);if(oldmat.dispose(),obj.material=mat,itm.position&&(obj.position.set(itm.position.x,itm.position.y,itm.position.z),itm.normal)){let d=new THREE.Vector3(itm.normal.x,itm.normal.y,itm.normal.z);d.add(obj.position),obj.lookAt(d)}}break;case MARenderMode.PATH:{if(itm.vertices||itm.tangents||itm.normals){let oldgeom=obj.geometry,geom=this.makePathGeometry(itm.vertices,itm.tangents,itm.normals);oldgeom.dispose(),obj.geometry=geom}let oldmat=obj.material,mat=this._makeMaterial(obj.geometry,itm);oldmat.dispose(),obj.material=mat,void 0!==itm.visible&&(obj.visible=itm.visible)}}}_updateAllMesh(gProp){for(let i=0,l=this.scene.children.length;i<l;i++){let child=this.scene.children[i];child&&"Mesh"===child.type&&child.material&&!child.material.map&&(this._updateObj(child,gProp),this.render())}}_makeRenderItem(gProp){let ok=!0,itm=new MARenderItem;for(let p in gProp)switch(p){case"name":case"path":case"side":case"text":case"position":case"normal":itm[p]=gProp[p];break;case"yaw":case"dist":case"size":case"color":case"pitch":case"style":case"extrude":case"opacity":case"segments":case"linewidth":itm[p]=Number(gProp[p]);break;case"visible":case"transparent":itm[p]=Boolean(gProp[p]);break;case"mode":{let mode=this._checkRenderMode(gProp[p]);mode&&(itm[p]=mode)}break;case"texture":case"tangents":case"normals":case"vertices":itm[p]=gProp[p].slice(0);break;case"clipping":if(gProp[p]&&gProp[p]instanceof THREE.Plane){let pln=(new THREE.Plane).copy(gProp[p]);itm.clipping=[pln]}else itm.clipping=this.noClipPlanes;break;default:ok=!1,console.log("MARenderer._makeRenderItem() unknown property: "+p)}return ok||(itm=void 0),itm}_checkRenderMode(gMode){let rMode=void 0;if(gMode)switch(Number(gMode)){case MARenderMode.BASIC:case MARenderMode.WIREFRAME:case MARenderMode.LAMBERT:case MARenderMode.PHONG:case MARenderMode.EMISSIVE:case MARenderMode.POINT:case MARenderMode.SECTION:case MARenderMode.MARKER:case MARenderMode.LABEL:case MARenderMode.PATH:case MARenderMode.SHAPE:rMode=gMode;break;default:console.log("MARenderer: Unknown mode: "+gMode)}return rMode}_makeMaterial(geom,itm){let mat,sProp={};switch(itm.mode&&(sProp.color=itm.color,sProp.opacity=itm.opacity,sProp.transparent=itm.transparent,sProp.visible=itm.visible,itm.clipping&&(sProp.clippingPlanes=itm.clipping)),itm.mode){case MARenderMode.BASIC:sProp.wiretrame=!1,mat=new THREE.MeshBasicMaterial(sProp);break;case MARenderMode.WIREFRAME:sProp.wireframe=!0,sProp.wireframeLinewidth=1,mat=new THREE.MeshLambertMaterial(sProp);break;case MARenderMode.LAMBERT:sProp.wireframe=!1,sProp.side=itm.side,mat=new THREE.MeshLambertMaterial(sProp);break;case MARenderMode.PHONG:case MARenderMode.SHAPE:sProp.specular=1118481,sProp.wireframe=!1,sProp.side=itm.side,sProp.emissive=0,sProp.shininess=25,this._setMaterialOpacity(sProp,itm.transparent,itm.opacity),mat=new THREE.MeshPhongMaterial(sProp);break;case MARenderMode.EMISSIVE:sProp.specular=7829367,sProp.wireframe=!1,sProp.emissive=itm.color,sProp.shininess=15,sProp.side=itm.side,mat=new THREE.MeshPhongMaterial(sProp);break;case MARenderMode.POINT:{sProp.size=this.pointSize,sProp.blending=THREE.CustomBlending,sProp.blendSrc=THREE.SrcColorFactor,sProp.blendDst=THREE.DstAlphaFactor,sProp.blendEquation=THREE.AddEquation,sProp.alphaTest=.3;let tx=THREE.ImageUtils.loadTexture("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAQAAABuBnYAAAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfgAg8MNSkRqlGqAAAAVElEQVQI113NQQ0DIRBA0TcEFYQTSVWsAHRUWXUgoDY4bbAxPfS2X8D7ATk1nFhU8u0ysLPFp+Z0mTpe5CmaoYNuaMWj4thucNtOjZWNP+obK57bH17lGKmOV2FkAAAAAElFTkSuQmCC");sProp.map=tx,void 0!==geom.attributes.colors&&geom.attributes.colors.array.length>0?(mat=new AlphaPointsMaterial(sProp)).vertexColors=THREE.VertexColors:mat=new THREE.PointsMaterial(sProp)}break;case MARenderMode.PATH:sProp.alphaTest=.2,sProp.linewidth=itm.linewidth,sProp.vertexColors=!0,mat=new MARenderPathMaterial(sProp);break;case MARenderMode.SECTION:sProp.transparent=itm.transparent,sProp.alphaTest=.2,sProp.wireframe=!1,sProp.side=THREE.DoubleSide,mat=new THREE.MeshBasicMaterial(sProp);break;case MARenderMode.MARKER:case MARenderMode.LABEL:if(sProp.alphaTest=.1,itm.mode===MARenderMode.MARKER){let tx=THREE.ImageUtils.loadTexture("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAIAAQMAAADuZfHZAAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfkCRUQCRIVi1+ZAAADLUlEQVRo3u2ZQZKjMAxFoVh46SNwFB8NH81H8RFYsnDZPckEkGR9AjXVmyn9VVdeEvsrWJbUw3CqtThoak0n8wuU/vWxvZX0D7S2qSu8JF+fdpD1b+qXX5r+Xcc3yX35E6wMhBMUsARfZCSvs0UcBVlfm0clUFDB2nR1tjb9tSYOsr429T5zsOmbotvimyLbEq8f2xolSFqk6H69BKu+23O/QYICdnsY6UADNnYjYw+SFvTTiOvBqvvbwdyDDYGiG98dLgg0RRBE3fhf69N3kEYWE0fsehVEspGVhKrQKGwEZBrpjbwp0h+tnKGq7PcnoLBnrJ7vWdnjSkDmp+7ceuRP/gnEIYo7qOLYxf2zRRzUtINNHO20b2MViegAWWSJvP+RRF7J+0ejONsHkLl87cHyAV5mtcBAkWDrwfwBs8ycnoFVgtIDx0DuQZBgYiBJUHsw3gOxB4sEwz3QX64KWP4JVAW0+yAY+H0Af6hr0H4JsCfxyUMNz8f9o8YPJzzOCviSMiBQ0pKXYP6W4UBO3NNr7dMrzLsghfdgRLeBvCayuFgyvnHgHSVvtYDuQXlBHvttEqTuruW3s+vAxqtMXgzwQiGwe7v1IMkqY6YFnVdApWVbodVgIrUWLXFe7woqkBWkewQyquHyVXE3PgLxqrLEtejyANTrQjig0nl+ADZUt2/XBb17APJ1NwH7DwhgKzM01Pwst0FFnVdFvVr51sT522BFHeSqN8Jn8ppQMwq7VNjXDg11wstNUL9327Mew4vG3SPg0AzAoakBHCeMIFQyJhGBG0MOPBYJekRETMqd0YvTI3IxxZkQgAOhEUSEx+TW0Ilar/qITM6vZt04iwkHDs3IJt34xbhtRGAAEcEjvdN6RaCgsaEcQXoEnG78YjQ5AX+n9YjGnx1YwFxUTC56h/1U1qPZq9f9kaIOTGXz/cHvAPwNSpNAHVYEChpHbwrwur+PQw1Mur+Pw/RkSP52qI7Vg+7vbaSowOv+3mBVgdNtvB2qNl4O9f8CDMDGH4cVgIDAXADwGwBuBWDKAIwJgCEOJpPJZDKZTCaTyWQymUwmk8lkMplM/69+AFlip7zBTAeRAAAAAElFTkSuQmCC");sProp.map=tx,mat=new MARenderMarkerMaterial(sProp)}else{sProp.text=itm.text;let canvas=document.createElement("canvas"),context=canvas.getContext("2d");context.font=this.labelFont.weight+" "+this.labelFont.size+"px "+this.labelFont.family,context.lineWidth=1,context.strokeStyle="rgba(255,255,255,255)",context.fillStyle="rgba(255,255,255,255)",context.fillText(sProp.text,1,this.labelFont.size+1);let tx=new THREE.Texture(canvas);tx.needsUpdate=!0,sProp.map=tx,mat=new MARenderLabelMaterial(sProp)}}return mat}_computeCenter(){let n=0,box=new THREE.Box3;for(let i=0,l=this.scene.children.length;i<l;i++){let child=this.scene.children[i];if(child&&("Mesh"===child.type||"Points"===child.type)){++n;let b=new THREE.Box3;b.setFromObject(child),b.min.add(child.position),b.max.add(child.position),1==n?box.copy(b):box.union(b)}}if(n>0){let d,min,max,dMax;min=box.min.x,max=box.max.x,dMax=box.max.x-box.min.x,(d=box.max.y-box.min.y)>dMax&&(dMax=d),min>box.min.y&&(min=box.min.y),max<box.max.y&&(max=box.max.y),(d=box.max.z-box.min.z)>dMax&&(dMax=d),min>box.min.z&&(min=box.min.z),max<box.max.z&&(max=box.max.z),this.center.set((box.min.x+box.max.x)/2,(box.min.y+box.max.y)/2,(box.min.z+box.max.z)/2),this.nearPlane=min<.2?.1:.5*min,this.farPlane=max<1?10:10*max,this.cameraPos.set(0,0,this.center.z+4*dMax)}}_testCode(){console.log("ren.version = "+this.version),console.log("cen = ("+this.center.x+", "+this.center.y+", "+this.center.z+")"),console.log("near = "+this.nearPlane),console.log("far = "+this.farPlane),console.log("pos = "+this.camera.position.x+", "+this.camera.position.y+", "+this.camera.position.z+")"),console.log("up = ("+this.camera.up.x+", "+this.camera.up.y+", "+this.camera.up.z+")"),console.log("ren.setCamera(new THREE.Vector3("+this.center.x+", "+this.center.y+", "+this.center.z+"), "+this.nearPlane+", "+this.farPlane+", new THREE.Vector3("+this.camera.position.x+", "+this.camera.position.y+", "+this.camera.position.z+"));\nren.setHome(new THREE.Vector3("+this.cameraControls.object.position.x+", "+this.cameraControls.object.position.y+", "+this.cameraControls.object.position.z+"), new THREE.Vector3("+this.camera.up.x+", "+this.camera.up.y+", "+this.camera.up.z+"));"),console.log("mousePos = ("+this.mousePos.x+", "+this.mousePos.y+")")}_pick(e){let doPick=!0;if("pointerdown"===e.type||"pointerup"===e.type)if(doPick=!1,"pointerdown"===e.type&&1===e.buttons)this.pickTimestamp=e.timeStamp;else if("pointerup"===e.type&&0===e.buttons){Math.abs(this.pickTimestamp-e.timeStamp)<=this.pickMaxPointerDelay&&(doPick=!0)}if(doPick){let pos=this.mousePos;pos.y=pos.y+this.pickOfs,this.raycaster.setFromCamera(pos,this.camera);let isct=this.raycaster.intersectObjects(this.scene.children,!1);isct.length>0&&this.eventHandler.dispatchEvent({type:"pick",hitlist:isct})}}_trackMouse(e){this.mousePos.x=(e.clientX-this.conOffset.x)/this.con.clientWidth*2-1,this.mousePos.y=-(e.clientY-this.conOffset.y)/this.con.clientHeight*2+1,this.makeLive()}_keyPressed(e){switch(e.charCode){case 33:this._testCode();break;case 60:this.opacityIncrement(-.1);break;case 62:this.opacityIncrement(.1);break;case 63:this._pick(e);break;case 67:this.setCamera();break;case 72:this.setHome();break;case 104:this.goHome();break;case 112:this.pointSizeIncrement(.1);break;case 113:this.pointSizeIncrement(-.1);break;case 115:this._updateAllMesh({mode:MARenderMode.PHONG});break;case 119:this._updateAllMesh({mode:MARenderMode.WIREFRAME})}console.log("MARender: charCode = "+e.charCode)}_windowResize(){this.handleWindowResize(),this.makeLive()}}export{MARenderMode,MARenderShape,MARenderItem,MARenderFont,MARenderer};
