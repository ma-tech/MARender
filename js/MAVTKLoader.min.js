import*as THREE from"./three.module.js";class MAVTKLoader extends THREE.Loader{constructor(manager){super(manager)}load(url,onLoad,onProgress,onError){const scope=this,loader=new THREE.FileLoader(scope.manager);void 0!==loader.crossOrigin&&void 0!==loader.setCrossOrigin&&loader.setCrossOrigin(this.crossOrigin),loader.setPath(scope.path),loader.setResponseType("arraybuffer"),loader.setRequestHeader(scope.requestHeader),loader.setWithCredentials(scope.withCredentials),loader.load(url,function(text){try{onLoad(scope.parse(THREE.LoaderUtils.decodeText(text)))}catch(e){onError?onError(e):console.error(e),scope.manager.itemError(url)}},onProgress,onError)}parse(data){var idx,pattern,result,point_type,n_points=0,n_polys=0,n_dpp=0,geometry=new THREE.BufferGeometry,vertices=[],indices=[],colors=[],opacities=[],sizes=[];if((result=(pattern=/#[\s]+vtk[\s]+DataFile[\s]+Version[\s]+\d+\.\d+/gi).exec(data))&&(0,0,reg_index=pattern.lastIndex,(pattern=/ASCII/g).lastIndex=reg_index,result=pattern.exec(data)),result&&(0,reg_index=pattern.lastIndex,(pattern=/DATASET[\s]+POLYDATA/g).lastIndex=reg_index,result=pattern.exec(data)),result&&(0,(pattern=/POINTS[\s]+([1-9]+[\d]*)[\s]+float/g).lastIndex=reg_index,null!==(result=pattern.exec(data))&&(n_points=parseInt(result[1]))),n_points>0)for(reg_index=pattern.lastIndex,(pattern=/(([+-]?[\d]+[.]?[\d\+\-eE]*)[\s]+([+-]?[\d]+[.]?[\d\+\-eE]*)[\s]+([+-]?[\d]+[.]?[\d\+\-eE]*))/g).lastIndex=reg_index,idx=0;idx<n_points&&(0,result=pattern.exec(data));++idx)vertices.push(parseFloat(result[2]),parseFloat(result[3]),parseFloat(result[4]));n_points>0&&result&&(0,null!==(result=(pattern=/(POLYGONS)[\s]+([1-9]+[\d]*)[\s]+([1-9]+[\d]*)/g).exec(data))?"POLYGONS"===result[1]?(n_polys=parseInt(result[2]),n_dpp=parseInt(result[3])/n_polys):result=null:result=!0);if(n_points>0&&result)if(n_polys>0){if(4===n_dpp){var reg_index=pattern.lastIndex;for((pattern=/3[\s]+([\d]+)[\s]+([\d]+)[\s]+([\d]+)/g).lastIndex=reg_index,idx=0;idx<n_polys&&(0,null!==(result=pattern.exec(data)));++idx)indices.push(parseInt(result[1]),parseInt(result[2]),parseInt(result[3]))}else if(5===n_dpp){reg_index=pattern.lastIndex;for((pattern=/4[\s]+([\d]+)[\s]+([\d]+)[\s]+([\d]+)[\s]+([\d]+)/g).lastIndex=reg_index,idx=0;idx<n_polys&&(0,null!==(result=pattern.exec(data)));++idx)indices.push(parseInt(result[1]),parseInt(result[2]),parseInt(result[4])),indices.push(parseInt(result[2]),parseInt(result[3]),parseInt(result[4]))}}else if(0,null!==(result=(pattern=/(POINT_DATA)[\s]+([1-9]+[\d]*)/g).exec(data)))if("POINT_DATA"===result[1]&&Number(result[2])==n_points){0;reg_index=pattern.lastIndex;if((pattern=/(SCALARS)[\s]+([\S]+)[\s]+([\S]+)/g).lastIndex=reg_index,null===(result=pattern.exec(data))||"SCALARS"!==result[1]||"char"!==result[3]&&"float"!==result[3])result=null;else if(point_type="char"===result[3]?"C":"F",(pattern=/(LOOKUP_TABLE)[\s]+(default)/g).lastIndex=reg_index,null===(result=pattern.exec(data))||"LOOKUP_TABLE"!==result[1]||"default"!==result[2])result=null;else for((pattern=/([+-]?[\d]+[.]?[\d\+\-eE]*)/g).lastIndex=reg_index,idx=0;idx<n_points&&(0,null!==(result=pattern.exec(data)));++idx){var a="C"===point_type?parseInt(result[1])/255:parseFloat(result[1]);a<0?a=0:a>1&&(a=1),colors.push(a,a,a);var aa=(a*a+.1)/1.1;opacities.push(a),sizes.push(aa)}}else result=null;else result=!0;return null===result?geometry=null:(geometry.setAttribute("position",new THREE.Float32BufferAttribute(vertices,3)),indices.length>0&&(geometry.setIndex(indices),geometry.computeVertexNormals()),colors.length>0&&(geometry.setAttribute("colors",new THREE.Float32BufferAttribute(colors,3)),geometry.setAttribute("opacities",new THREE.Float32BufferAttribute(opacities,1)),geometry.setAttribute("sizes",new THREE.Float32BufferAttribute(sizes,1)),geometry.attributes.colors.needsUpdate=!0),geometry.computeBoundingBox(),geometry.computeBoundingSphere()),geometry}}export{MAVTKLoader};
